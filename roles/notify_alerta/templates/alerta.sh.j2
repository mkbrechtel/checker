#!/bin/bash

set -e

# Alerta API settings
ALERTA_API_ALERT_URL={{ notify_alerta_api_alert_url | quote }}
ALERTA_API_KEY={{ notify_alerta_api_key | quote }}
ALERTA_ENVIRONMENT={{ notify_alerta_environment | quote }}

# Parse arguments
hostname="$1"
check_id="$2"
exit_code="$3"

# Map exit code to severity
case $exit_code in
    0) severity="ok" ;;
    1) severity="warning" ;;
    2) severity="critical" ;;
    3) severity="unknown" ;;
    *) severity="debug" ;;
esac

cat \
| jo \
    text=@- \
    resource="$hostname" \
    event="$check_id" \
    environment="$ALERTA_ENVIRONMENT" \
    severity="$severity" \
    value="$exit_code" \
    service="[\"$hostname\"]" \
    origin=checker \
    type=checkerCheck \
| curl -s \
    -X POST \
    -H "Authorization: Key $ALERTA_API_KEY" \
    -H "Content-Type: application/json" \
    -d @- \
    --fail-with-body \
    "$ALERTA_API_ALERT_URL"
